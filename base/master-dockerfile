# Dockerfile for generating base image for {{os_brand}}:{{os_codename}}

FROM {{os_brand}}:{{os_codename}}
MAINTAINER Cloudant, An IBM Company <support@cloudant.com>
ENV DEBIAN_FRONTEND noninteractive

{% if os_brand == 'debian' %}
# Use httpredir
RUN sed -i s/http.debian.net/httpredir.debian.org/g /etc/apt/sources.list
{% endif %}

{% if os_codename == 'lucid' %}
# For some reason, home is not set at this point
ENV HOME /root
{% endif %}

# Install minimal and common build dependencies
RUN apt-get -qq update && \
    apt-get install -qq -y --force-yes --no-install-recommends \
    adduser \
    autoconf \
    automake \
    build-essential \
    ca-certificates \
    curl \
    libz-dev \
    libpcre3 \
    libpcre3-dev \
    python \
    python-pip \
    python-setuptools \
    rsync \
    s3cmd \
    subversion \
    sudo \
    tar \
    unzip \
    vim \
    wget \
    less \
    libncurses5-dev \
    lsb-release \
    libssl-dev \
    libreadline-dev

# Add Cloudant APT repo
{% if os_brand == 'ubuntu' %}
RUN echo "deb [arch=amd64] http://apt-us.cloudant.net/cloudant-{{os_brand}} {{os_codename}}-production main" >> /etc/apt/sources.list
{% else %}
RUN echo "deb http://apt-us.cloudant.net/cloudant-{{os_brand}} {{os_codename}}-production main" >> /etc/apt/sources.list
{% endif %}
RUN curl http://apt.cloudant.net/Cloudant.gpg.key | apt-key add -
RUN apt-get -qq update

{% if os_codename == 'lucid' %}
RUN apt-get install -qq -y git-core
{% else %}
RUN apt-get install -qq -y git
{% endif %}

{% if os_codename != 'trusty' %}
RUN apt-get install -qq -y rubygems
{% endif %}

# Install kerl
RUN curl -o /usr/local/bin/kerl https://raw.githubusercontent.com/spawngrid/kerl/master/kerl
RUN chmod +x /usr/local/bin/kerl

# Build erlang releases
ENV KERL_CONFIGURE_OPTIONS --enable-kernel-poll --enable-hipe --enable-threads --enable-smp-support --enable-m64-build
ENV CFLAGS -D_FORTIFY_SOURCE=0
RUN mkdir -p /opt/builds

RUN kerl build 17.5 17.5
RUN kerl install 17.5 /opt/builds/17.5

RUN kerl build git https://github.com/erlang/otp.git OTP-18.1.3 18.1.3
RUN kerl install 18.1.3 /opt/builds/18.1.3
